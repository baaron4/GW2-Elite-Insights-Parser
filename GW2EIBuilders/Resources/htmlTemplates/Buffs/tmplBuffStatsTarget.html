<template>
    <div>
        <div>
            <h3 class="text-center">Conditions</h3>
            <buff-table-component :condition="true" :generation="true" :id="'condition-stats-target-table-' + target.id" :buffs="conditions"
                :playerdata="condiData" :sums="condiSums" :playerindex="playerindex" :hidecustom="false"></buff-table-component>
        </div>
        <div v-show="hasBoons" class="mt-2">
            <h3 class="text-center">Boons</h3>
            <buff-table-component :condition="false" :generation="false" :id="'boon-stats-target-table-' + target.id" :buffs="boons"
                :playerdata="boonData" :sums="[]" :hidecustom="false"></buff-table-component>
        </div>
    </div>
</template>

<script>
    Vue.component("buff-stats-target-component", {
        props: ['playerindex', 'targetindex'],
        mixins: [buffComponent, encounterPhaseComponent],
        template: `${template}`,
        data: function () {
            return {
                cacheCondi: new Map(),
                cacheCondiSums: new Map(),
                cacheBoon: new Map()
            };
        },
        computed: {
            target: function() {
                return logData.targets[this.targetindex];
            },
            targetPhaseIndex: function () {
                return this.phase.targets.indexOf(this.targetindex);
            },
            hasBoons: function () {
                return this.buffsStatContainer.targetsBoonUptimes[this.targetPhaseIndex].avg > 0;
            },
            cacheID: function() {
                return this.encounterPhase.id + '-' + this.phaseindex;
            },
            condiData: function () {
                const cacheID = this.encounterPhase.id + '-' + this.phaseindex;
                if (this.cacheCondi.has(cacheID)) {
                    return this.cacheCondi.get(cacheID);
                }
                const players = getActivePlayersForPhase(this.encounterPhase);
                const res = [];
                if (this.targetPhaseIndex === -1) {
                    for (let i = 0; i < players.length; i++) {
                        if (!players[i]) {
                            continue;
                        }
                        res.push({
                            player: players[i],
                            data: {
                                avg: 0.0,
                                data: []
                            }
                        });
                    }
                } else {
                    for (let i = 0; i < players.length; i++) {
                        if (!players[i]) {
                            continue;
                        }
                        res.push({
                            player: players[i],
                            data: this.buffsStatContainer.targetsCondiStats[this.targetPhaseIndex][i]
                        });
                    }
                }
                this.cacheCondi.set(cacheID, res);
                return res;
            },
            condiSums: function () {
                const cacheID = this.phaseindex;
                if (this.cacheCondiSums.has(cacheID)) {
                    return this.cacheCondiSums.get(cacheID);
                }
                const res = [];
                if (this.targetPhaseIndex === -1) {
                    res.push({
                        icon: this.target.icon,
                        name: this.target.name,
                        avg: 0,
                        data: []
                    });
                } else {
                    const targetData = this.buffsStatContainer.targetsCondiUptimes[this.targetPhaseIndex];
                    res.push({
                        icon: this.target.icon,
                        name: this.target.name,
                        avg: targetData.avg,
                        data: targetData.data
                    });
                }
                this.cacheCondiSums.set(cacheID, res);
                return res;
            },
            boonData: function () {
                const cacheID = this.phaseindex;
                if (this.cacheBoon.has(cacheID)) {
                    return this.cacheBoon.get(cacheID);
                }
                const res = [];
                if (this.targetPhaseIndex === -1 || !this.hasBoons) {
                    res.push({
                        player: this.target,
                        data: {
                            avg: 0.0,
                            data: []
                        }
                    });
                } else {
                    const targetData = this.phase.buffsStatContainer.targetsBoonUptimes[this.targetPhaseIndex];
                    res.push({
                        player: this.target,
                        data: targetData
                    });
                }
                this.cacheBoon.set(cacheID, res);
                return res;
            }
        }
    });
</script>
